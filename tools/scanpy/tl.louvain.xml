<tool id="tl.louvain" name="tl.louvain" version="1.3.1+galaxy1">
    <description>Cluster cells into subgroups</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
    ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.tl.louvain(
    adata=adata,
    flavor = '$flavor.flavor',
    #if $flavor.flavor == 'vtraag' and $flavor.resolution
    resolution=$flavor.resolution,
    #end if
    random_state=$random_state,
    key_added='$key_added',
    copy=False)

@CMD_anndata_write_outputs@
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="flavor">
            <param argument="flavor" type="select" label="Flavor for the clustering" help="">
                <option value="vtraag">vtraag (much more powerful)</option>
                <option value="igraph">igraph</option>
            </param>
            <when value="vtraag">
                <param argument="resolution" type="float" value="" optional="true" label="Resolution" help="Higher resolution means finding more and smaller clusters, which defaults to 1.0. See “Time as a resolution parameter” in Lambiotte et al, 2009"/>
            </when>
            <when value="igraph"/>
        </conditional>
        <param argument="random_state" type="integer" value="0" label="Random state" help="Change the initialization of the optimization."/>
        <param argument="key_added" type="text" value="louvain" optional="true" label="Key under which to add the cluster labels" help=""/>
        <expand macro="anndata_output_format"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pp.neighbors.paul15_gauss_braycurtis.h5ad" />
            </conditional>
            <conditional name="flavor">
                <param name="flavor" value="vtraag"/>
                <param name="resolution" value="1.0"/>
            </conditional>
            <param name="random_state" value="10"/>
            <param name="key_added" value="louvain"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="tl.louvain.neighbors.paul15_gauss_braycurtis.h5ad" ftype="h5" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Cluster cells using the Louvain algorithm (Blondel et al, 2008) in the implementation
of Traag et al,2017. The Louvain algorithm has been proposed for single-cell
analysis by Levine et al, 2015.

This requires to run `pp.neighbors`, first.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.tl.louvain.html#scanpy.api.tl.louvain>`_
    ]]></help>
    <expand macro="citations"/>
</tool>
