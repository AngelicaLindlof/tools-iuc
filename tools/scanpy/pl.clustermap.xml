<tool id="pl.clustermap" name="pl.clustermap" version="1.3.1+galaxy1">
    <description>Hierarchically-clustered heatmap</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
          python $script_file
      ]]>
    </command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.settings.figdir = '.'

#if $use_raw=="True"
data=adata.X
#else
data=adata
#end if

g = sc.pl.clustermap(
    adata=data,
    obs_keys='$obs_keys',
    use_raw=$use_raw,
    method='$seaborn_clustermap.method',
    metric='$seaborn_clustermap.metric',
    z_score=$seaborn_clustermap.z_score,
    standard_scale=$seaborn_clustermap.standard_scale,
    col_cluster='$seaborn_clustermap.col_cluster',
    row_cluster='$seaborn_clustermap.row_cluster',
    show=False)

g.savefig(fname="output.$format")
  ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="obs_keys" type="text" value="" label="Categorical annotation to plot with a different color map" help="Currently, only a single key is supported."/>
        <expand macro="param_use_raw"/>
        <expand macro="param_plot_format"/>
        <section name="seaborn_clustermap" title="Parameters for seaborn.clustermap">
            <param name="method" type="select" label="Linkage method to use for calculating clusters" help="More details in https://docs.scipy.org/doc/scipy/reference/generated/scipy.cluster.hierarchy.linkage.html">
                <option value="single">single: Nearest Point Algorithm</option>
                <option value="complete">complete: Farthest Point Algorithm or Voor Hees Algorithm</option>
                <option value="average">average: UPGMA algorithm</option>
                <option value="weighted">weighted: WPGMA algorithm</option>
                <option value="centroid">centroid: UPGMC algorithm</option>
                <option value="median">median: WPGMC algorithm</option>
                <option value="ward">ward: incremental algorithm</option>
            </param>
            <param name="metric" type="select" label="Distance metric to use for the data" help="See scipy.spatial.distance.pdist documentation for more options https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.pdist.html">
                <expand macro="distance_metric_options"/>
            </param>
            <param name="z_score" type="select" label="Calculate z-scores for the rows or the columns?" help="Z scores are: z = (x - mean)/std, so values in each row (column) will get the mean of the row (column) subtracted, then divided by the standard deviation of the row (column). This ensures that each row (column) has mean of 0 and variance of 1.">
                <option value="None">No Z-score</option>
                <option value="0">Rows</option>
                <option value="1">Columns</option>
            </param>
            <param name="standard_scale" type="select" label="Standardize a dimension?" help="It means for each row or column, subtract the minimum and divide each by its maximum.">
                <option value="None">No standardization</option>
                <option value="0">Rows</option>
                <option value="1">Columns</option>
            </param>
            <param name="col_cluster" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Cluster the columns?" help=""/>
            <param name="row_cluster" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Cluster the rows?" help=""/>
        </section>
    </inputs>
    <outputs>
        <expand macro="plot_output"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="obs_keys" value="cell_type"/>
            <param name="use_raw" value="False"/>
            <param name="format" value="png"/>
            <section name="seaborn_clustermap">
                <param name="method" value="single"/>
                <param name="metric" value="braycurtis"/>
                <param name="z_score" value="None"/>
                <param name="standard_scale" value="None"/>
                <param name="col_cluster" value="False"/>
                <param name="row_cluster" value="False"/>
            </section>
            <output name="out_png" file="pl.clustermap.krumsiek11.png" ftype="png" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Hierarchically-clustered heatmap.

Wraps `seaborn.clustermap
<https://seaborn.pydata.org/generated/seaborn.clustermap.html>`__ for
`anndata.AnnData`.

The returned object has a savefig() method that should be used if you want
to save the figure object without clipping the dendrograms.

To access the reordered row indices, use:
clustergrid.dendrogram_row.reordered_ind

Column indices, use: clustergrid.dendrogram_col.reordered_ind

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pl.clustermap.html#scanpy.api.pl.clustermap>`__
]]></help>
    <expand macro="citations"/>
</tool>
