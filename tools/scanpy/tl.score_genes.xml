<tool id="tl.score_genes" name="tl.score_genes" version="1.3.1+galaxy1">
    <description>Score a set of genes</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.tl.score_genes(
    adata=adata,
    gene_list=$gene_list.replace(' ','').split(','),
    ctrl_size=$ctrl_size,
    score_name='$score_name',\
    #if $gene_pool
    
    gene_pool=$gene_pool.replace(' ','').split(','),\
    #end if
    @CMD_score_genes_inputs@)

@CMD_anndata_write_outputs@
adata.obs.to_csv('$obs', sep='\t')
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="gene_list" type="text" value="" label="The list of gene names used for score calculation" help="Genes separated by a comma"/>
        <param argument="ctrl_size" type="integer" value="50" label="Number of reference genes to be sampled" help="If `len(gene_list)` is not too low, you can set `ctrl_size=len(gene_list)`."/>
        <param argument="gene_pool" type="text" value="" optional="true" label="Genes for sampling the reference set" help="Default is all genes. Genes separated by a comma"/>
        <expand macro="score_genes_params"/>
        <param argument="score_name" type="text" value="score" label="Name of the field to be added in `.obs`" help=""/>
        <expand macro="anndata_output_format"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
        <data name="obs" format="tabular" label="${tool.name} on ${on_string}: Observations annotation"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <param name="gene_list" value="Gata2, Fog1"/>
            <param name="ctrl_size" value="2"/>
            <param name="n_bins" value="2"/>
            <param name="random_state" value="0"/>
            <param name="use_raw" value="False"/>
            <param name="score_name" value="score"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="tl.score_genes.krumsiek11.h5ad" ftype="h5" compare="sim_size"/>
            <output name="obs" file="tl.score_genes.krumsiek11.obs.tabular" ftype="tabular" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
The score is the average expression of a set of genes subtracted with the
average expression of a reference set of genes. The reference set is
randomly sampled from the `gene_pool` for each binned expression value.

This reproduces the approach in Seurat (Satija et al, 2015) and has been implemented
for Scanpy by Davide Cittaro.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.tl.score_genes.html#scanpy.api.tl.score_genes>`_
    ]]></help>
    <expand macro="citations"/>
</tool>
