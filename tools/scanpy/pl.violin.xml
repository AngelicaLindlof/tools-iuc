<tool id="pl.violin" name="pl.violin" version="1.3.1+galaxy1">
    <description>Violin plot.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.settings.figdir = '.'

#if $key_variables.type == "var_names"
key_list = adata.var_names
#else if $key_variables.type == "obs"
key_list = adata.obs.select_dtypes(exclude=['category']).columns
#else if $key_variables.type == "custom"
key_list=[]
    #for $i, $s in enumerate($key_variables.key_variables)
key_list.append('$s.var')
    #end for
#end if

sc.pl.violin(
    adata=adata,
    keys=key_list,
#if $groupby
    groupby='$groupby',
#end if
    log=$log,
    use_raw=$use_raw,
    multi_panel=$multi_panel,
    stripplot=$stripplot.stripplot,
#if $stripplot.stripplot == "True"
    jitter=$stripplot.jitter.jitter,
    #if $stripplot.jitter.jitter == "True"
    size=$stripplot.jitter.size,
    #end if
#end if
    scale='$scale',
#if $xlabel
    xlabel='$xlabel',
#end if
#if $rotation
    rotation=$rotation,
#end if
    bw='$seaborn_violinplot.bw',
#if $seaborn_violinplot.orient
    orient='$seaborn_violinplot.orient',
#end if
    linewidth=$seaborn_violinplot.linewidth,
    color='$seaborn_violinplot.color',
    palette='$seaborn_violinplot.palette',
    saturation=$seaborn_violinplot.saturation,
    save='.$format',
    show=False)
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="key_variables">
            <param name="type" type="select" label="Keys for accessing variables">
                <option value="var_names">All variables in `.var_names`</option>
                <option value="obs">All fields in `.obs`</option>
                <option value="custom">Subset of variables in `adata.var_names` or fields of `.obs`"</option>
            </param>
            <when value="var_names"/>
            <when value="obs"/>
            <when value="custom">
                <repeat name="key_variables" title="Keys for accessing variables" help="">
                    <param name="var" type="text" value="" label="Variable" help="It should be from `.var_names` or fields of `.obs`"/>
                </repeat>
            </when>
        </conditional>
        <expand macro="param_groupby"/>
        <expand macro="param_log"/>
        <expand macro="param_use_raw"/>
        <param argument="multi_panel" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Display keys in multiple panels" help="Also when `groupby is not provided"/>
        <conditional name="stripplot">
            <param argument="stripplot" type="select" label="Add a stripplot on top of the violin plot" help="">
                <option value="True">Yes</option>
                <option value="False">No</option>
            </param>
            <when value="True">
                <conditional name="jitter">
                    <param argument="jitter" type="select" label="Add a jitter to the stripplot" help="">
                        <option value="True">Yes</option>
                        <option value="False">No</option>
                    </param>
                    <when value="True">
                        <param argument="size" type="integer" value="1" label="Size of the jitter points" help=""/>
                    </when>
                    <when value="False"/>
                </conditional>
            </when>
            <when value="False"/>
        </conditional>
        <param argument="scale" type="select" label="Method used to scale the width of each violin">
            <option value="area">area: each violin will have the same area</option>
            <option value="count">count: the width of the violins will be scaled by the number of observations in that bin</option>
            <option value="width" selected="true">width: each violin will have the same width</option>
        </param>
        <param argument="xlabel" type="text" value="" optional="true" label="Label of the x axis" help="Defaults to `groupby` if `rotation` is `None`,    otherwise, no label is shown."/>
        <param argument="rotation" type="float" value="" optional="true" label="Rotation of xtick labels" help=""/>
        <expand macro="param_plot_format"/>
        <section name="seaborn_violinplot" title="Parameters for seaborn.violinplot">
            <param argument="bw" type="select" label="Name of a reference rule when computing the kernel bandwidth">
                <option value="scott">scott</option>
                <option value="silverman">silverman</option>
            </param>
            <param argument="orient" type="select" optional="true" label="Orientation of the plot">
                <option value="v">vertical</option>
                <option value="h">horizontal</option>
            </param>
            <param argument="linewidth" type="float" value="0" label="Width of the gray lines that frame the plot elements" help=""/>
            <param argument="color" type="select" label="Color for all of the elements" help="">
                <expand macro="matplotlib_color"/>
            </param>
            <param argument="palette" type="select" label="Colors to use for the different levels of the hue variable" help="">
                <expand macro="matplotlib_pyplot_colormap"/>
            </param>
            <param argument="saturation" type="float" value="0.75" min="0" max="1" label="Proportion of the original saturation to draw colors at" help=""/>
        </section>
    </inputs>
    <outputs>
        <expand macro="plot_output"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="key_variables">
                <param name="type" value="custom"/>
                <repeat name="key_variables" >
                    <param name="var" value="n_genes" />
                </repeat>
                <repeat name="key_variables" >
                    <param name="var" value="percent_mito" />
                </repeat>
            </conditional>
            <param name="groupby" value="bulk_labels"/>
            <param name="log" value="False"/>
            <param name="use_raw" value="False"/>
            <param name="multi_panel" value="False"/>
            <conditional name="stripplot">
                <param name="stripplot" value="False"/>
            </conditional>
            <param name="scale" value="width"/>
            <param name="xlabel" value=""/>
            <param name="rotation" value=""/>
            <param name="format" value="png"/>
            <section name="seaborn_violinplot">
                <param name="bw" value="scott"/>
                <param name="linewidth" value="0"/>
                <param name="color" value="AliceBlue"/>
                <param name="palette" value="viridis"/>
                <param name="saturation" value="0.75"/>
            </section>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_custom.png" ftype="png" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="key_variables">
                <param name="type" value="var_names"/>
            </conditional>
            <param name="log" value="False"/>
            <param name="use_raw" value="False"/>
            <param name="multi_panel" value="False"/>
            <conditional name="stripplot">
                <param name="stripplot" value="True"/>
                <conditional name="jitter">
                    <param name="jitter" value="False"/>
                </conditional>
            </conditional>
            <param name="scale" value="width"/>
            <param name="format" value="png"/>
            <section name="seaborn_violinplot">
                <param name="bw" value="scott"/>
                <param name="linewidth" value="0"/>
                <param name="color" value="AliceBlue"/>
                <param name="palette" value="viridis"/>
                <param name="saturation" value="0.75"/>
            </section>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_var_names.png" ftype="png" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="key_variables">
                <param name="type" value="obs"/>
            </conditional>
            <param name="log" value="True"/>
            <param name="use_raw" value="False"/>
            <param name="multi_panel" value="True"/>
            <conditional name="stripplot">
                <param name="stripplot" value="True"/>
                <conditional name="jitter">
                    <param name="jitter" value="True"/>
                    <param name="size" value="1"/>
                </conditional>
            </conditional>
            <param name="scale" value="width"/>
            <param name="format" value="png"/>
            <section name="seaborn_violinplot">
                <param name="bw" value="scott"/>
                <param name="linewidth" value="0"/>
                <param name="color" value="AliceBlue"/>
                <param name="palette" value="viridis"/>
                <param name="saturation" value="0.75"/>
            </section>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_obs.png" ftype="png" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[

Wraps `seaborn.violinplot` for `anndata.AnnData`.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pl.violin.html#scanpy.api.pl.violin>`__
    ]]></help>
    <expand macro="citations"/>
</tool>
