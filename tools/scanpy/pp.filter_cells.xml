<tool id="pp.filter_cells" name="pp.filter_cells" version="1.3.1+galaxy1">
  <description>Filter cell outliers based on counts and numbers of genes expressed.</description>
  <macros>
    <import>macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <command detect_errors="exit_code"><![CDATA[
        python $script_file
    ]]></command>
  <configfiles>
    <configfile name="script_file"><![CDATA[
import scanpy.api as sc

@CMD_read_inputs

sc.pp.filter_cells(
   data = '$adata',
   min_counts = '$min_counts',
   min_genes = '$min_genes',
   max_counts = '$max_counts',
   max_genes = '$max_genes',
   copy = '$copy',)

adata.write_loom($csv_output)
adata.write_csv($loom_output)
]]></configfile>
  </configfiles>
  <inputs>
    <expand macro="inputs_anndata"/>
    <param name="min_counts" type="int" value="None" optional="true" label="min_counts" help="    Minimum number of counts required for a cell to pass filtering."/>
    <param name="min_genes" type="int" value="None" optional="true" label="min_genes" help="    Minimum number of genes expressed required for a cell to pass filtering."/>
    <param name="max_counts" type="int" value="None" optional="true" label="max_counts" help="    Maximum number of counts required for a cell to pass filtering."/>
    <param name="max_genes" type="int" value="None" optional="true" label="max_genes" help="    Maximum number of genes expressed required for a cell to pass filtering."/>
    <param name="copy" type="bool" value="False" optional="true" label="copy" help="    If an :class:`~anndata.AnnData` is passed, determines whether a copy    is returned."/>
    </inputs>
  <outputs>
    <data name="csv_output" type="data" format="csv" label="${tool.name} on ${on_string}: Annotated matrix (csv)"/>
    <data name="cell_subset" type="np.ndarray" label="${tool.name} on ${on_string}: cell_subset"/>
    <data name="number_per_cell" type="np.ndarray" label="${tool.name} on ${on_string}: number_per_cell"/>
    <data name="loom_output" type="data" format="loom" label="${tool.name} on ${on_string}: Annotated matrix (loom)"/>
    </outputs>
  <tests>
    <test>
      <param name="min_counts" value=""/>
      <param name="min_genes" value=""/>
      <param name="max_counts" value=""/>
      <param name="max_genes" value=""/>
      <param name="copy" value=""/>
      <output name="loom_output" file=""/>
      <output name="csv_output" file=""/>
      <output name="cell_subset" file=""/>
      <output name="number_per_cell" file=""/>
      <output name="loom_output" file=""/>
    </test>
  </tests>
  <help><![CDATA[
        Filter cell outliers based on counts and numbers of genes expressed.

For instance, only keep cells with at least `min_counts` counts or
`min_genes` genes expressed. This is to filter measurement outliers, i.e.,
"unreliable" observations.

Only provide one of the optional parameters `min_counts`, `min_genes`,
`max_counts`, `max_genes` per call.

Parameters
----------
data : :class:`~anndata.AnnData`, `np.ndarray`, `sp.spmatrix`
    The (annotated) data matrix of shape `n_obs` Ã— `n_vars`. Rows correspond
    to cells and columns to genes.
min_counts : `int`, optional (default: `None`)
    Minimum number of counts required for a cell to pass filtering.
min_genes : `int`, optional (default: `None`)
    Minimum number of genes expressed required for a cell to pass filtering.
max_counts : `int`, optional (default: `None`)
    Maximum number of counts required for a cell to pass filtering.
max_genes : `int`, optional (default: `None`)
    Maximum number of genes expressed required for a cell to pass filtering.
copy : `bool`, optional (default: `False`)
    If an :class:`~anndata.AnnData` is passed, determines whether a copy
    is returned.

Returns
-------
If `data` is an :class:`~anndata.AnnData`, filters the object and adds    either `n_genes` or `n_counts` to `adata.obs`. Otherwise a tuple

cell_subset : `np.ndarray`
    Boolean index mask that does filtering. `True` means that the cell is
    kept. `False` means the cell is removed.
number_per_cell : `np.ndarray`
    Either `n_counts` or `n_genes` per cell.

Examples
--------
>>> adata = sc.datasets.krumsiek11()
>>> adata.n_obs
640
>>> adata.var_names
['Gata2' 'Gata1' 'Fog1' 'EKLF' 'Fli1' 'SCL' 'Cebpa'
 'Pu.1' 'cJun' 'EgrNab' 'Gfi1']
>>> # add some true zeros
>>> adata.X[adata.X < 0.3] = 0
>>> # simply compute the number of genes per cell
>>> sc.pp.filter_cells(adata, min_genes=0)
>>> adata.n_obs
640
>>> adata.obs['n_genes'].min()
1
>>> # filter manually
>>> adata_copy = adata[adata.obs['n_genes'] >= 3]
>>> adata_copy.obs['n_genes'].min()
>>> adata.n_obs
554
>>> adata.obs['n_genes'].min()
3
>>> # actually do some filtering
>>> sc.pp.filter_cells(adata, min_genes=3)
>>> adata.n_obs
554
>>> adata.obs['n_genes'].min()
3
    ]]></help>
  <expand macro="citations"/>
</tool>
