<tool id="tl.dpt" name="tl.dpt" version="1.3.1+galaxy1">
    <description>Infer progression of cells through geodesic distance along the graph</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.tl.dpt(
    adata=adata,
    n_dcs=$n_dcs,
    n_branchings=$n_branchings,
    min_group_size=$min_group_size,
    allow_kendall_tau_shift=$allow_kendall_tau_shift,
    copy=False)

@CMD_anndata_write_outputs@
adata.obs.to_csv('$obs', sep='\t')
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <param argument="n_dcs" type="integer" value="10" label="Number of diffusion components to use" help=""/>
        <param argument="n_branchings" type="integer" value="0" label="Number of branchings to detect" help=""/>
        <param argument="min_group_size" type="float" value="0.01" label="Min group size" help="During recursive splitting of branches ('dpt groups') for `n_branchings` &gt; 1, do not consider groups that contain less than `min_group_size` data points. If a float, `min_group_size` refers to a fraction of the total number of data points."/>
        <param argument="allow_kendall_tau_shift" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Allow Kendal tau shift?" help="If a very small branch is detected upon splitting, shift away from maximum correlation in Kendall tau criterion of Haghverdi et al (2016) to stabilize the splitting."/>
        <expand macro="anndata_output_format"/>
    </inputs>
    <outputs>
        <expand macro="anndata_outputs"/>
        <data name="obs" format="tabular" label="${tool.name} on ${on_string}: Observations annotation"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pp.neighbors.paul15_gauss_braycurtis.h5ad" />
            </conditional>
            <param name="n_dcs" value="10"/>
            <param name="n_branchings" value="1"/>
            <param name="min_group_size" value="0.01"/>
            <param name="allow_kendall_tau_shift" value="True"/>
            <param name="anndata_output_format" value="h5ad" />
            <output name="anndata_out_h5ad" file="tl.dpt.neighbors.paul15_gauss_braycurtis.h5ad" ftype="h5" compare="sim_size"/>
            <output name="obs" file="tl.dpt.neighbors.paul15_gauss_braycurtis.obs.tabular"/>
        </test>
    </tests>
    <help><![CDATA[
Reconstruct the progression of a biological process from snapshot
data. `Diffusion Pseudotime` has been introduced by Haghverdi et al (2016) and
implemented within Scanpy (Wolf et al, 2017). Here, we use a further developed
version, which is able to deal with disconnected graphs (Wolf et al, 2017) and can
be run in a `hierarchical` mode by setting the parameter
`n_branchings>1`. We recommend, however, to only use
`tl.dpt` for computing pseudotime (`n_branchings=0`) and
to detect branchings via `paga`. For pseudotime, you need
to annotate your data with a root cell. 

This requires to run `pp.neighbors`, first. In order to
reproduce the original implementation of DPT, use `method=='gauss'` in
this. Using the default `method=='umap'` only leads to minor quantitative
differences, though.


Returns
-------

If `n_branchings==0`, no field `dpt_groups` will be written.

- dpt_pseudotime : Array of dim (number of samples) that stores the pseudotime of each cell, that is, the DPT distance with respect to the root cell.
- dpt_groups : Array of dim (number of samples) that stores the subgroup id ('0','1', ...) for each cell. The groups  typically correspond to 'progenitor cells', 'undecided cells' or 'branches' of a process.

Notes
-----
The tool is similar to the R package `destiny` of Angerer et al (2016).

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.tl.dpt.html#scanpy.api.tl.dpt>`_
    ]]></help>
    <expand macro="citations"/>
</tool>
