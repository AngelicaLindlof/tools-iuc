<tool id="pp.filter_cells" name="pp.filter_cells" version="1.3.1+galaxy1">
    <description>Filter cell outliers based on counts and numbers of genes expressed</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
            python $script_file
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

res = sc.pp.filter_cells(
    #if $modify_anndata.modify_anndata == 'true'
    adata,
    #else
    adata.X,
    #end if
    #if $filter.filter == 'min_counts'
    min_counts=$filter.min_counts,
    #elif $filter.filter == 'max_counts'
    max_counts=$filter.max_counts,
    #elif $filter.filter == 'min_genes'
    min_genes=$filter.min_genes,
    #elif $filter.filter == 'max_genes'
    max_genes=$filter.max_genes,
    #end if
    copy=False)

@CMD_anndata_write_modify_outputs@

#if $modify_anndata.modify_anndata == 'true'
df = adata.obs
#else
df = pd.DataFrame(data=dict(cell_subset=res[0], number_per_cell=res[1]))
#end if

#if $filter.filter == 'min_counts' or $filter.filter == 'max_counts'
df.to_csv('$counts_per_cell', sep='\t')
#elif $filter.filter == 'min_genes' or $filter.filter == 'max_genes'
df.to_csv('$genes_per_cell', sep='\t')
#end if
    ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="filter">
            <param argument="filter" type="select" label="Filter">
                <option value="min_counts">Minimum number of counts</option>
                <option value="max_counts">Maximum number of counts</option>
                <option value="min_genes">Minimum number of genes expressed</option>
                <option value="max_genes">Maximum number of genes expressed</option>
            </param>
            <when value="min_counts">
                <param argument="min_counts" type="integer" value="" label="Minimum number of counts required for a cell to pass filtering" help=""/>
            </when>
            <when value="max_counts">
                <param argument="max_counts" type="integer" value="" label="Maximum number of counts required for a cell to pass filtering" help=""/>
            </when>
            <when value="min_genes">
                <param argument="min_genes" type="integer" value="" label="Minimum number of genes expressed required for a cell to pass filtering" help=""/>
            </when>    
            <when value="max_genes">
                <param argument="max_genes" type="integer" value="" label="Maximum number of genes expressed required for a cell to pass filtering" help=""/>
            </when>
        </conditional>
        <expand macro="anndata_modify_output_input"/>
    </inputs>
    <outputs>
        <expand macro="anndata_modify_outputs"/>
        <data name="counts_per_cell" format="tabular" label="${tool.name} on ${on_string}: Counts per cells after filtering">
            <filter>filter['filter'] == 'min_counts' or filter['filter'] == 'max_counts'</filter>
        </data>
        <data name="genes_per_cell" format="tabular" label="${tool.name} on ${on_string}: Number of genes per cell after filtering">
            <filter>filter['filter'] == 'min_genes' or filter['filter'] == 'max_genes'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad" />
            </conditional>
            <conditional name="filter">
                <param name="filter" value="min_counts"/>
                <param name="min_counts" value="3"/>
            </conditional>
            <conditional name="modify_anndata">
                <param name="modify_anndata" value="true"/>
                <param name="anndata_output_format" value="h5ad" />
            </conditional>
            <output name="anndata_out_h5ad" file="pp.filter_cells.krumsiek11-min_counts.h5ad" ftype="h5" compare="sim_size"/>
            <output name="counts_per_cell" file="pp.filter_cells.number_per_cell.krumsiek11-min_counts.tabular"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="krumsiek11.h5ad"/>
            </conditional>
            <conditional name="filter">
                <param name="filter" value="max_genes"/>
                <param name="max_genes" value="100"/>
            </conditional>
            <conditional name="modify_anndata">
                <param name="modify_anndata" value="false"/>
            </conditional>
            <output name="genes_per_cell" file="pp.filter_cells.number_per_cell.krumsiek11-max_genes.tabular"/>
        </test>
    </tests>
    <help><![CDATA[
Filter cell outliers based on counts and numbers of genes expressed.

For instance, only keep cells with at least `min_counts` counts or
`min_genes` genes expressed. This is to filter measurement outliers, i.e.,
"unreliable" observations.

Only provide one of the optional parameters `min_counts`, `min_genes`,
`max_counts`, `max_genes` per call.

Return
------

number_per_cell : Number per cell (either `n_counts` or `n_genes` per cell)

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pp.filter_cells.html#scanpy.api.pp.filter_cells>`__

]]>
    </help>
    <expand macro="citations"/>
</tool>
