<tool id="scanpy_plot_quality" name="Plot quality" version="@version@">
    <description>with scanpy</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
          python $script_file
      ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
@CMD_read_inputs@

sc.settings.figdir = '.'

#if $method.method == 'pl.violin'
    #if $method.key_variables.type == "var_names"
key_list = adata.var_names
    #elif $method.key_variables.type == "obs"
key_list = adata.obs.select_dtypes(exclude=['category']).columns
    #elif $method.key_variables.type == "custom"
key_list=[]
        #for $i, $s in enumerate($method.key_variables.key_variables)
key_list.append('$s.var')
        #end for
    #end if

sc.pl.violin(
    adata=adata,
    keys=key_list,
    #if $method.groupby
    groupby='$method.groupby',
    #end if
    log=$method.log,
    use_raw=$method.use_raw,
    @CMD_params_violin_plots@
    #if $method.xlabel
    xlabel='$method.xlabel',
    #end if
    #if $method.rotation
    rotation=$method.rotation,
    #end if
    @CMD_params_seaborn_violinplot@
    save='.$format',
    show=False)
#end if
]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="inputs_anndata"/>
        <conditional name="method">
            <param argument="method" type="select" label="Method used for plotting">
                <option value="pl.violin">Violin plot, using `pl.violin`</option>
            </param>
            <when value="pl.violin">
                <conditional name="key_variables">
                    <param name="type" type="select" label="Keys for accessing variables">
                        <option value="var_names">All variables in `.var_names`</option>
                        <option value="obs">All fields in `.obs`</option>
                        <option value="custom">Subset of variables in `adata.var_names` or fields of `.obs`"</option>
                    </param>
                    <when value="var_names"/>
                    <when value="obs"/>
                    <when value="custom">
                        <repeat name="key_variables" title="Keys for accessing variables" help="">
                            <param name="var" type="text" value="" label="Variable" help="It should be from `.var_names` or fields of `.obs`"/>
                        </repeat>
                    </when>
                </conditional>
                <expand macro="param_groupby"/>
                <expand macro="param_log"/>
                <expand macro="param_use_raw"/>
                <expand macro="violin_plots"/>
                <param argument="xlabel" type="text" value="" optional="true" label="Label of the x axis" help="Defaults to `groupby` if `rotation` is `None`,    otherwise, no label is shown."/>
                <param argument="rotation" type="float" value="" optional="true" label="Rotation of xtick labels" help=""/>
                <expand macro="seaborn_violinplot"/>
            </when>
        </conditional>
        <expand macro="param_plot_format"/>
    </inputs>
    <outputs>
        <expand macro="plot_output"/>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="method">
                <param name="method" value="pl.violin"/>
                <conditional name="key_variables">
                    <param name="type" value="custom"/>
                    <repeat name="key_variables" >
                        <param name="var" value="n_genes" />
                    </repeat>
                    <repeat name="key_variables" >
                        <param name="var" value="percent_mito" />
                    </repeat>
                </conditional>
                <param name="groupby" value="bulk_labels"/>
                <param name="log" value="False"/>
                <param name="use_raw" value="False"/>
                <conditional name="multi_panel">
                    <param name="multi_panel" value="False"/>
                </conditional>
                <conditional name="stripplot">
                    <param name="stripplot" value="False"/>
                </conditional>
                <param name="scale" value="width"/>
                <param name="xlabel" value=""/>
                <param name="rotation" value=""/>
                <param name="format" value="png"/>
                <section name="seaborn_violinplot">
                    <param name="bw" value="scott"/>
                    <param name="linewidth" value="0"/>
                    <param name="color" value="AliceBlue"/>
                    <param name="palette" value="viridis"/>
                    <param name="saturation" value="0.75"/>
                </section>
            </conditional>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_custom.png" ftype="png" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="method">
                <param name="method" value="pl.violin"/>
                <conditional name="key_variables">
                    <param name="type" value="var_names"/>
                </conditional>
                <param name="log" value="False"/>
                <param name="use_raw" value="False"/>
                <conditional name="multi_panel">
                    <param name="multi_panel" value="False"/>
                </conditional>
                <conditional name="stripplot">
                    <param name="stripplot" value="True"/>
                    <conditional name="jitter">
                        <param name="jitter" value="False"/>
                    </conditional>
                </conditional>
                <param name="scale" value="width"/>
                <param name="format" value="png"/>
                <section name="seaborn_violinplot">
                    <param name="bw" value="scott"/>
                    <param name="linewidth" value="0"/>
                    <param name="color" value="AliceBlue"/>
                    <param name="palette" value="viridis"/>
                    <param name="saturation" value="0.75"/>
                </section>
            </conditional>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_var_names.png" ftype="png" compare="sim_size"/>
        </test>
        <test>
            <conditional name="input">
                <param name="format" value="h5ad" />
                <param name="adata" value="pbmc68k_reduced.h5ad" />
            </conditional>
            <conditional name="method">
                <param name="method" value="pl.violin"/>
                <conditional name="key_variables">
                    <param name="type" value="obs"/>
                </conditional>
                <param name="log" value="True"/>
                <param name="use_raw" value="False"/>
                <conditional name="multi_panel">
                    <param name="multi_panel" value="True"/>
                </conditional>
                <conditional name="stripplot">
                    <param name="stripplot" value="True"/>
                    <conditional name="jitter">
                        <param name="jitter" value="True"/>
                        <param name="size" value="1"/>
                    </conditional>
                </conditional>
                <param name="scale" value="width"/>
                <param name="format" value="png"/>
                <section name="seaborn_violinplot">
                    <param name="bw" value="scott"/>
                    <param name="linewidth" value="0"/>
                    <param name="color" value="AliceBlue"/>
                    <param name="palette" value="viridis"/>
                    <param name="saturation" value="0.75"/>
                </section>
            </conditional>
            <output name="out_png" file="pl.violin.pbmc68k_reduced_obs.png" ftype="png" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
Violin plot, using `pl.violin`
==============================

Wraps `seaborn.violinplot` for `anndata.AnnData`.

More details on the `scanpy documentation
<https://scanpy.readthedocs.io/en/latest/api/scanpy.api.pl.stacked_violin.html#scanpy.api.pl.stacked_violin>`__
    ]]></help>
    <expand macro="citations"/>
</tool>
